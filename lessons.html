<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>openLingo - Aprende Idiomas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* RESET Y VARIABLES */
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #10b981;
            --accent-color: #8b5cf6;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --gray-color: #64748b;
            --light-gray: #e2e8f0;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
            --transition-fast: all 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: var(--light-color);
            min-height: 100vh;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* HEADER SIMPLIFICADO */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 24px 0;
            margin-bottom: 32px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .app-header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo i {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 50%;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* BOTONES REDISEÑADOS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
            text-decoration: none;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: translateY(2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: var(--box-shadow);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            box-shadow: var(--box-shadow-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color), #34d399);
            color: white;
            box-shadow: var(--box-shadow);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #f87171);
            color: white;
            box-shadow: var(--box-shadow);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #fbbf24);
            color: white;
            box-shadow: var(--box-shadow);
        }

        .btn-recording {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
            animation: pulse 1.5s infinite;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.5); }
            50% { box-shadow: 0 0 30px rgba(220, 38, 38, 0.8); }
        }

        /* SECCIÓN PRINCIPAL */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }

        /* TARJETAS DE ACCIÓN */
        .action-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--light-gray);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--dark-color);
            font-weight: 600;
        }

        .section-title i {
            color: var(--primary-color);
        }

        .section-description {
            color: var(--gray-color);
            margin-bottom: 20px;
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* FORMULARIOS MEJORADOS */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: var(--transition-fast);
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* LISTA DE LECCIONES */
        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .lesson-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid var(--light-gray);
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        .lesson-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--box-shadow-hover);
        }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .lesson-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
            line-height: 1.4;
            flex: 1;
        }

        .lesson-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .lesson-tag {
            display: inline-block;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            color: var(--primary-dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .lesson-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .lesson-tag-small {
            display: inline-block;
            background: var(--light-gray);
            color: var(--gray-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* BOTÓN FAVORITO */
        .favorite-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--light-gray);
            z-index: 10;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            border-color: #f59e0b;
        }

        .favorite-btn.favorited i {
            color: white;
        }

        /* BARRA DE BÚSQUEDA Y FILTROS */
        .search-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--light-gray);
            margin-bottom: 20px;
        }

        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
            background: white;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-tag {
            padding: 6px 12px;
            background: var(--light-color);
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .filter-tag:hover {
            background: var(--light-gray);
        }

        .filter-tag.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* PESTAÑAS */
        .tabs-container {
            display: flex;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .tab-badge {
            display: inline-block;
            background: var(--light-gray);
            color: var(--gray-color);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* MODALES REDISEÑADOS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.4rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .modal-body {
            padding: 20px;
        }

        /* INTERFAZ DE LECCIÓN - REDISEÑADA PARA MÓVIL */
        .lesson-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* PROGRESO SIMPLIFICADO */
        .lesson-progress {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 16px;
            box-shadow: var(--box-shadow);
            margin: 16px 0;
            border: 1px solid var(--light-gray);
        }

        .progress-bar {
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .progress-navigation {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        /* TABLA DE VOCABULARIO OPTIMIZADA PARA MÓVIL */
        .vocabulary-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 16px 0;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--light-gray);
        }

        .vocabulary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .vocabulary-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            font-weight: 600;
            padding: 12px 10px;
            text-align: left;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
        }

        .vocabulary-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--light-gray);
            font-size: 0.9rem;
            vertical-align: top;
            word-break: break-word;
        }

        .vocabulary-table tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.02);
        }

        /* EJERCICIOS OPTIMIZADOS PARA MÓVIL */
        .exercise {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 2px solid var(--light-gray);
            transition: var(--transition);
            margin-bottom: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .exercise.current {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .exercise.completed {
            border-color: var(--secondary-color);
            background-color: rgba(16, 185, 129, 0.02);
        }

        .exercise h4 {
            color: var(--dark-color);
            margin-bottom: 16px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exercise-question {
            font-size: 1.05rem;
            margin-bottom: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .exercise-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            min-height: 56px;
        }

        .option-label:hover {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.02);
        }

        .option-label.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .option-label.correct {
            border-color: var(--secondary-color);
            background-color: rgba(16, 185, 129, 0.05);
        }

        .option-label.incorrect {
            border-color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.05);
        }

        /* PRONUNCIACIÓN - REDISEÑADA */
        .pronunciation-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 16px;
            border: 1px solid #bae6fd;
        }

        .pronunciation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .pronunciation-header h5 {
            font-size: 1.05rem;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .pronunciation-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 16px;
            padding: 14px;
            background: white;
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--light-gray);
            line-height: 1.6;
        }

        .pronunciation-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(220, 38, 38, 0.1);
            border-radius: var(--border-radius-sm);
            color: #dc2626;
            font-weight: 500;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .recording-indicator.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        /* FEEDBACK */
        .feedback {
            padding: 14px;
            border-radius: var(--border-radius-sm);
            margin-top: 16px;
            animation: fadeIn 0.3s;
            display: none;
            font-size: 0.9rem;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background-color: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .feedback.incorrect {
            background-color: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
        }

        .feedback-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        /* CONTROLES FLOTANTES */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--light-gray);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--box-shadow-hover);
        }

        .floating-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* CONEXIÓN - SIMPLIFICADO */
        .connection-status {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .connection-status.connected {
            color: var(--secondary-color);
            border: 2px solid var(--secondary-color);
        }

        /* PANEL TTS */
        .tts-panel {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: white;
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--box-shadow);
            width: 280px;
            max-width: 90vw;
            display: none;
            border: 1px solid var(--light-gray);
            z-index: 100;
        }

        .tts-panel.active {
            display: block;
            animation: modalSlideIn 0.3s;
        }

        /* QUICK REFERENCE SIMPLIFICADO */
        .quick-reference-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            backdrop-filter: blur(4px);
        }

        .quick-reference-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .quick-reference-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .quick-reference-header {
            background: linear-gradient(135deg, var(--accent-color), #7c3aed);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-reference-header h3 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-reference-body {
            padding: 24px 20px;
            text-align: center;
        }

        .quick-reference-word {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .quick-reference-dictionary-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 24px 0;
        }

        .dictionary-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            text-decoration: none;
            color: var(--dark-color);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .dictionary-link:hover {
            background: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .dictionary-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .dictionary-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .dictionary-arrow {
            color: var(--gray-color);
            font-size: 0.85rem;
        }

        .quick-reference-controls {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        /* TEXTO CLICKABLE PARA TTS */
        .clickable-text {
            cursor: pointer;
            transition: var(--transition-fast);
            display: inline;
            position: relative;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
        }

        .clickable-text:hover {
            background-color: rgba(37, 99, 235, 0.1);
        }

        .clickable-text.tts-disabled {
            cursor: default;
            background-color: transparent !important;
        }

        /* BOTÓN DESACTIVAR TTS */
        .tts-toggle-btn {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--light-gray);
            z-index: 100;
        }

        .tts-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--box-shadow-hover);
        }

        .tts-toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tts-toggle-btn.disabled {
            background: var(--light-gray);
            color: var(--gray-color);
        }

        /* SECCIONES DE LECCIÓN */
        .lesson-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--light-gray);
            margin-bottom: 20px;
        }

        .lesson-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .lesson-section-header h3 {
            font-size: 1.2rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .start-exercises-btn {
            margin-top: 24px;
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: var(--border-radius);
            border: 2px dashed #bae6fd;
        }

        /* FASE DE EJERCICIOS */
        .exercise-phase {
            margin-bottom: 20px;
        }

        .pronounce-question-phase,
        .pronounce-answer-phase {
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }

        /* UTILIDADES */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-4 {
            margin-top: 16px;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-3 {
            gap: 12px;
        }

        .w-full {
            width: 100%;
        }

        /* ANIMACIONES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 0.3s ease;
        }

        /* RESPONSIVE PARA MÓVILES */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .app-header {
                padding: 20px 0;
                margin-bottom: 24px;
            }
            
            .app-header .container {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .logo {
                font-size: 1.6rem;
            }
            
            .logo i {
                font-size: 1.8rem;
                padding: 8px;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .lessons-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .lesson-card {
                padding: 16px;
            }
            
            .lesson-title {
                font-size: 1.1rem;
            }
            
            .action-section,
            .search-section,
            .lesson-section {
                padding: 16px;
            }
            
            .modal-content {
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }
            
            .modal.active {
                padding: 0;
                align-items: stretch;
            }
            
            .modal-header {
                padding: 16px;
            }
            
            .modal-header h2 {
                font-size: 1.2rem;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .floating-controls {
                bottom: 16px;
                right: 16px;
            }
            
            .floating-btn {
                width: 48px;
                height: 48px;
                font-size: 1rem;
            }
            
            .tts-toggle-btn {
                bottom: 16px;
                left: 16px;
                width: 48px;
                height: 48px;
            }
            
            .tts-panel {
                bottom: 80px;
                right: 16px;
                width: calc(100vw - 32px);
                max-width: 280px;
            }
            
            .pronunciation-controls {
                flex-direction: column;
            }
            
            .pronunciation-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .progress-navigation {
                flex-direction: column;
            }
            
            .progress-navigation .btn {
                width: 100%;
                justify-content: center;
            }
            
            .quick-reference-word {
                font-size: 1.8rem;
                flex-direction: column;
                gap: 8px;
            }
            
            .dictionary-link {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-container .btn {
                width: 100%;
                justify-content: center;
            }
            
            .filters-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .tabs-container {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            /* TABLA DE VOCABULARIO RESPONSIVE */
            .vocabulary-table-container {
                margin: 0;
                border-radius: var(--border-radius-sm);
                border: 1px solid var(--light-gray);
                overflow-x: hidden;
                -webkit-overflow-scrolling: auto;
            }
            
            .vocabulary-table {
                min-width: 100%;
                display: block;
            }
            
            .vocabulary-table thead {
                display: none;
            }
            
            .vocabulary-table tbody,
            .vocabulary-table tr {
                display: block;
                width: 100%;
            }
            
            .vocabulary-table td {
                display: flex;
                align-items: flex-start;
                text-align: left;
                padding: 12px;
                border-bottom: 1px solid var(--light-gray);
                position: relative;
                min-height: 44px;
            }
            
            .vocabulary-table td:before {
                content: attr(data-label);
                position: relative;
                left: 0;
                width: 100px;
                min-width: 100px;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--primary-color);
                font-size: 0.8rem;
                line-height: 1.4;
            }
            
            .vocabulary-table td:last-child {
                border-bottom: 2px solid var(--primary-color);
            }
            
            .vocabulary-table tr {
                margin-bottom: 10px;
                border: 1px solid var(--light-gray);
                border-radius: var(--border-radius-sm);
                overflow: hidden;
                background: white;
            }
            
            .vocabulary-table td.clickable-text {
                font-weight: 600;
                color: var(--primary-dark);
                display: flex;
                align-items: center;
            }
            
            .vocabulary-table td.clickable-text:before {
                display: block;
            }
            
            .vocabulary-table td > span,
            .vocabulary-table td > em,
            .vocabulary-table td > div {
                flex: 1;
                word-break: break-word;
                line-height: 1.4;
            }
            
            .exercise-phase {
                padding: 12px;
            }
            
            .pronunciation-text {
                font-size: 1rem;
                padding: 12px;
            }
            
            .feedback {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .exercise {
                padding: 16px;
                max-height: 75vh;
            }
            
            .exercise-question {
                font-size: 1rem;
            }
            
            .option-label {
                padding: 12px;
                min-height: 52px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .connection-status {
                top: 12px;
                right: 12px;
                padding: 6px 12px;
                font-size: 0.75rem;
            }
            
            .exercise,
            .modal-content {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
            
            .pronunciation-controls .btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 360px) {
            .container {
                padding: 0 12px;
            }
            
            .lesson-card {
                padding: 12px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .exercise {
                padding: 12px;
            }
            
            .pronunciation-section {
                padding: 16px;
            }
            
            .vocabulary-table td {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .vocabulary-table td:before {
                font-size: 0.75rem;
                width: 80px;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- CONTROLES FLOTANTES -->
    <div class="floating-controls">
        <div class="floating-btn" id="sound-toggle" title="Activar/Desactivar sonidos">
            <i class="fas fa-volume-up"></i>
        </div>
        <div class="floating-btn" id="tts-toggle" title="Configurar narrador TTS">
            <i class="fas fa-robot"></i>
        </div>
    </div>

    <!-- PANEL TTS -->
    <div class="tts-panel" id="tts-panel">
        <h4 class="mb-4"><i class="fas fa-cog"></i> Configurar Narrador</h4>
        
        <div class="form-group">
            <label class="form-label">Voz del Narrador</label>
            <select class="form-select" id="tts-voice-select">
                <option value="">Cargando voces...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Velocidad: <span id="tts-speed-value">1.0</span></label>
            <input type="range" class="form-input" id="tts-speed-slider" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <button class="btn btn-secondary w-full mt-4" id="test-tts-btn">
            <i class="fas fa-play"></i> Probar Voz
        </button>
    </div>

    <!-- QUICK REFERENCE MODAL -->
    <div class="quick-reference-modal" id="quick-reference-modal">
        <div class="quick-reference-content">
            <div class="quick-reference-header">
                <h3><i class="fas fa-external-link-alt"></i> Buscar en Diccionarios</h3>
                <button class="btn btn-icon close-quick-reference" style="background: transparent; color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="quick-reference-body">
                <div class="quick-reference-word" id="quick-reference-word">
                    <!-- La palabra aparecerá aquí -->
                </div>
                
                <div class="quick-reference-dictionary-links" id="dictionary-links">
                    <!-- Los enlaces a diccionarios se generarán aquí -->
                </div>
                
                <div class="quick-reference-controls">
                    <button class="btn btn-primary" id="quick-reference-speak-btn">
                        <i class="fas fa-volume-up"></i> Escuchar
                    </button>
                    <button class="btn btn-secondary close-quick-reference">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="app-header">
        <div class="container">
            <div class="logo">
                <a href="https://gm-nelson.github.io/openLingo">
                    <i class="fas fa-language"></i>
                    <span>openLingo</span>
                </a>
            </div>
            <div class="header-controls">
                <button class="btn btn-secondary btn-small" id="refresh-lessons-btn">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <span id="lessons-count" style="color: white; font-size: 0.9rem;">
                    Cargando...
                </span>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container">
        <main class="main-content">
            <!-- SECCIÓN DE CREACIÓN -->
            <section class="action-section">
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    Crear Nueva Lección
                </h2>
                <p class="section-description">
                    Genera contenido personalizado usando IA o importa lecciones existentes.
                </p>
                
                <div class="flex gap-3" style="flex-wrap: wrap;">
                    <button class="btn btn-primary" id="generate-prompt-btn">
                        <i class="fas fa-robot"></i> Generar con IA
                    </button>
                    <button class="btn btn-secondary" id="show-import-btn">
                        <i class="fas fa-file-import"></i> Importar
                    </button>
                </div>

                <!-- IMPORTAR LECCIÓN -->
                <div id="import-section" class="hidden mt-4">
                    <div class="form-group">
                        <label class="form-label">Pega el JSON de la lección:</label>
                        <textarea class="form-textarea" id="lesson-json-input" 
                                  placeholder='{"title": "Mi lección", "language": "Inglés", "sections": [...]}'></textarea>
                    </div>
                    <button class="btn btn-success w-full" id="import-lesson-btn">
                        <i class="fas fa-upload"></i> Guardar Lección
                    </button>
                </div>
            </section>

            <!-- BARRA DE BÚSQUEDA Y FILTROS -->
            <section class="search-section">
                <h2 class="section-title">
                    <i class="fas fa-search"></i>
                    Buscar Lecciones
                </h2>
                
                <!-- PESTAÑAS -->
                <div class="tabs-container">
                    <button class="tab active" data-tab="all-lessons">
                        Todas
                        <span class="tab-badge" id="all-lessons-count">0</span>
                    </button>
                    <button class="tab" data-tab="favorites">
                        <i class="fas fa-heart" style="color: #ef4444;"></i>
                        Favoritos
                        <span class="tab-badge" id="favorites-count">0</span>
                    </button>
                </div>
                
                <!-- CONTENIDO DE PESTAÑAS -->
                <div class="tab-content active" id="all-lessons-tab">
                    <!-- Barra de búsqueda -->
                    <div class="search-container">
                        <input type="text" class="search-input" id="search-input" placeholder="Buscar lecciones...">
                        <button class="btn btn-primary" id="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filters-container">
                        <div class="filter-group">
                            <select class="filter-select" id="language-filter">
                                <option value="">Todos los idiomas</option>
                                <option value="Inglés">Inglés</option>
                                <option value="Español">Español</option>
                                <option value="Francés">Francés</option>
                                <option value="Alemán">Alemán</option>
                                <option value="Italiano">Italiano</option>
                                <option value="Portugués">Portugués</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select class="filter-select" id="level-filter">
                                <option value="">Todos los niveles</option>
                                <option value="principiante">Principiante</option>
                                <option value="intermedio">Intermedio</option>
                                <option value="avanzado">Avanzado</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select class="filter-select" id="topic-filter">
                                <option value="">Todos los temas</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Etiquetas de filtros activos -->
                    <div class="filter-tags" id="active-filters"></div>
                    
                    <!-- Resultados -->
                    <div class="lessons-grid" id="lessons-list">
                        <!-- Lecciones cargadas dinámicamente -->
                    </div>
                </div>
                
                <!-- PESTAÑA DE FAVORITOS -->
                <div class="tab-content" id="favorites-tab">
                    <!-- Barra de búsqueda para favoritos -->
                    <div class="search-container">
                        <input type="text" class="search-input" id="favorites-search-input" placeholder="Buscar en favoritos...">
                        <button class="btn btn-primary" id="favorites-search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- Filtros para favoritos -->
                    <div class="filters-container">
                        <div class="filter-group">
                            <select class="filter-select" id="favorites-language-filter">
                                <option value="">Todos los idiomas</option>
                                <option value="Inglés">Inglés</option>
                                <option value="Español">Español</option>
                                <option value="Francés">Francés</option>
                                <option value="Alemán">Alemán</option>
                                <option value="Italiano">Italiano</option>
                                <option value="Portugués">Portugués</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select class="filter-select" id="favorites-level-filter">
                                <option value="">Todos los niveles</option>
                                <option value="Principiante">Principiante</option>
                                <option value="Intermedio">Intermedio</option>
                                <option value="Avanzado">Avanzado</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Resultados de favoritos -->
                    <div class="lessons-grid" id="favorites-list">
                        <!-- Favoritos cargados dinámicamente -->
                    </div>
                    
                    <div id="empty-favorites" class="hidden text-center" style="padding: 40px 20px;">
                        <i class="fas fa-heart" style="font-size: 2.5rem; color: var(--light-gray); margin-bottom: 12px;"></i>
                        <p style="color: var(--gray-color); font-size: 0.9rem;">No tienes lecciones favoritas todavía.</p>
                        <p class="mt-4" style="color: var(--gray-color); font-size: 0.85rem;">
                            Haz clic en el icono <i class="fas fa-heart" style="color: #ef4444;"></i> en cualquier lección para agregarla a tus favoritos.
                        </p>
                    </div>
                </div>
                
                <div id="empty-lessons" class="hidden text-center" style="padding: 40px 20px;">
                    <i class="fas fa-book-open" style="font-size: 2.5rem; color: var(--light-gray); margin-bottom: 12px;"></i>
                    <p style="color: var(--gray-color); font-size: 0.9rem;">No hay lecciones disponibles. ¡Crea la primera!</p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL GENERADOR DE PROMPT -->
    <div id="ai-prompt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-robot"></i> Generador de Prompt</h2>
                <button class="btn btn-icon close-modal" style="background: transparent; color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="ai-prompt-form">
                    <div class="form-group">
                        <label class="form-label">Tema de la Lección</label>
                        <input type="text" class="form-input" id="topic" required 
                               placeholder="Ej: Comida, Viajes, Trabajo, Familia">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Etiquetas (Tags)</label>
                        <input type="text" class="form-input" id="tags" 
                               placeholder="Ej: verbos, comida, presente, viajes (separados por comas)">
                        <small style="color: var(--gray-color); font-size: 0.85rem;">Estas etiquetas ayudarán a otros a encontrar tu lección.</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Idioma a Aprender</label>
                        <select class="form-select" id="language" required>
                            <option value="Inglés">Inglés</option>
                            <option value="Español">Español</option>
                            <option value="Francés">Francés</option>
                            <option value="Alemán">Alemán</option>
                            <option value="Italiano">Italiano</option>
                            <option value="Portugués">Portugués</option>
                            <option value="Otro">Otro...</option>
                        </select>
                    </div>
                    
                    <div class="form-group hidden" id="other-language-group">
                        <label class="form-label">Especificar Idioma</label>
                        <input type="text" class="form-input" id="other-language" 
                               placeholder="Escribe el idioma">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nivel</label>
                        <select class="form-select" id="level" required>
                            <option value="principiante">Principiante</option>
                            <option value="intermedio" selected>Intermedio</option>
                            <option value="avanzado">Avanzado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Duración</label>
                        <select class="form-select" id="duration" required>
                            <option value="10">10 minutos (5 ejercicios)</option>
                            <option value="20">20 minutos (10 ejercicios)</option>
                            <option value="30" selected>30 minutos (15 ejercicios)</option>
                            <option value="40">40 minutos (20 ejercicios)</option>
                            <option value="50">50 minutos (25 ejercicios)</option>
                        </select>
                        <small style="color: var(--gray-color); font-size: 0.85rem;">Cada 2 minutos = 1 ejercicio aproximadamente</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Comentarios Adicionales (Opcional)</label>
                        <textarea class="form-input" id="additional-comments" 
                                  placeholder="Añade cualquier especificación adicional que quieras incluir en la lección (gramática, vocabulario, contexto, etc.)"
                                  rows="3"></textarea>
                        <small style="color: var(--gray-color); font-size: 0.85rem;">Usa este espacio para cualquier detalle adicional que quieras incluir.</small>
                    </div>
                </form>
                
                <div class="mt-4" style="background: #f8fafc; padding: 16px; border-radius: var(--border-radius-sm);">
                    <h4 class="mb-3"><i class="fas fa-copy"></i> Prompt para IA</h4>
                    <div id="generated-prompt" style="
                        font-family: 'Courier New', monospace;
                        font-size: 0.85rem;
                        background: white;
                        padding: 14px;
                        border-radius: var(--border-radius-sm);
                        border: 1px solid var(--light-gray);
                        max-height: 250px;
                        overflow-y: auto;
                        white-space: pre-wrap;
                        word-break: break-all;
                    "></div>
                    
                    <div class="flex gap-3 mt-4">
                        <button class="btn btn-primary" id="copy-prompt-btn">
                            <i class="far fa-copy"></i> Copiar
                        </button>
                        <button class="btn btn-secondary close-modal">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE LECCIÓN -->
    <div id="lesson-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="lesson-title"></h2>
                <button class="btn btn-icon close-lesson-modal" style="background: transparent; color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="lesson-content"></div>
            </div>
        </div>
    </div>

<script>
// ==================== ESTADO GLOBAL ====================
const appState = {
    currentLesson: null,
    currentExerciseIndex: 0,
    totalExercises: 0,
    completedExercises: new Set(),
    exercisePhases: {},
    voiceSystem: null,
    soundSystem: null,
    ttsEnabled: true,
    quickReferenceData: {},
    currentWord: '',
    favorites: new Set(),
    allLessons: [],
    filteredLessons: [],
    filteredFavorites: [],
    activeTab: 'all-lessons',
    activeFilters: {
        language: '',
        level: '',
        topic: '',
        search: ''
    },
    favoriteFilters: {
        language: '',
        level: '',
        search: ''
    },
    availableTopics: new Set()
};

// ==================== LECCIONES POR DEFECTO ====================
// ==================== LECCIONES POR DEFECTO ====================
const defaultLessons = [
    {
        id: 'lesson-1',
        title: 'English Basics: Greetings and Introductions',
        language: 'English',
        level: 'beginner',
        topic: 'Greetings',
        tags: ['basic', 'conversation', 'introductions'],
        estimatedTime: 15,
        createdAt: new Date().toISOString(),
        author: 'System',
        sections: [
            {
                type: 'introduction',
                title: 'Introduction',
                content: 'In this lesson you will learn basic greetings in English and how to introduce yourself. This is the first step to start conversations in English. Perfect for Spanish speakers who want to learn everyday English.'
            },
            {
                type: 'vocabulary',
                title: 'Vocabulary',
                table: [
                    {
                        word: 'Hello',
                        translation: 'Hola',
                        pronunciation: 'heˈləʊ',
                        example: 'Hello, my name is John.'
                    },
                    {
                        word: 'Good morning',
                        translation: 'Buenos días',
                        pronunciation: 'ɡʊd ˈmɔːnɪŋ',
                        example: 'Good morning, how are you?'
                    },
                    {
                        word: 'Good afternoon',
                        translation: 'Buenas tardes',
                        pronunciation: 'ɡʊd ˌɑːftəˈnuːn',
                        example: 'Good afternoon, nice to meet you.'
                    },
                    {
                        word: 'Good evening',
                        translation: 'Buenas noches',
                        pronunciation: 'ɡʊd ˈiːvnɪŋ',
                        example: 'Good evening, welcome to our home.'
                    },
                    {
                        word: 'How are you?',
                        translation: '¿Cómo estás?',
                        pronunciation: 'haʊ ɑːr juː',
                        example: 'Hello, how are you today?'
                    },
                    {
                        word: 'I am fine',
                        translation: 'Estoy bien',
                        pronunciation: 'aɪ æm faɪn',
                        example: 'I am fine, thank you.'
                    },
                    {
                        word: 'Nice to meet you',
                        translation: 'Mucho gusto',
                        pronunciation: 'naɪs tə miːt juː',
                        example: 'Hello, I am Maria. Nice to meet you.'
                    },
                    {
                        word: 'Goodbye',
                        translation: 'Adiós',
                        pronunciation: 'ɡʊdˈbaɪ',
                        example: 'Goodbye, see you tomorrow.'
                    }
                ]
            },
            {
                type: 'exercises',
                title: 'Exercises',
                items: [
                    {
                        type: 'multiple_choice',
                        question: 'How do you say "Hola" in English?',
                        options: ['Good morning', 'Hello', 'Goodbye', 'Thank you'],
                        correctAnswer: 1,
                        completeAnswer: 'Hello',
                        questionToSpeak: 'How do you say Hola in English',
                        correctOptionText: 'Hello'
                    },
                    {
                        type: 'multiple_choice',
                        question: 'Complete the sentence: "___ afternoon, nice to meet you."',
                        options: ['Hello', 'Good', 'Morning', 'Hi'],
                        correctAnswer: 1,
                        completeAnswer: 'Good afternoon nice to meet you',
                        questionToSpeak: 'Complete the sentence Good afternoon nice to meet you',
                        correctOptionText: 'Good'
                    },
                    {
                        type: 'true_false',
                        statement: '"Good morning" means "Buenas noches" in Spanish.',
                        correctAnswer: false,
                        explanation: '"Good morning" means "Buenos días". "Good night" means "Buenas noches".',
                        completeAnswer: 'Good morning means Buenos días not Buenas noches',
                        questionToSpeak: 'Good morning means Buenas noches in Spanish',
                        correctOptionText: 'False'
                    },
                    {
                        type: 'multiple_choice',
                        question: 'What is the correct response to "How are you?"?',
                        options: ['Good morning', 'I am fine', 'Goodbye', 'Hello'],
                        correctAnswer: 1,
                        completeAnswer: 'I am fine',
                        questionToSpeak: 'What is the correct response to How are you',
                        correctOptionText: 'I am fine'
                    },
                    {
                        type: 'multiple_choice',
                        question: 'How do you say "Mucho gusto" in English?',
                        options: ['Good morning', 'How are you', 'Nice to meet you', 'Goodbye'],
                        correctAnswer: 2,
                        completeAnswer: 'Nice to meet you',
                        questionToSpeak: 'How do you say Mucho gusto in English',
                        correctOptionText: 'Nice to meet you'
                    }
                ]
            }
        ]
    },
    {
        id: 'lesson-2',
        title: 'Food Vocabulary - From Spanish to English',
        language: 'English',
        level: 'beginner',
        topic: 'Food',
        tags: ['vocabulary', 'food', 'restaurant', 'shopping'],
        estimatedTime: 20,
        createdAt: new Date(Date.now() - 86400000).toISOString(),
        author: 'System',
        sections: [
            {
                type: 'introduction',
                title: 'Introduction',
                content: 'Learn essential food vocabulary in English. This lesson is perfect for Spanish speakers who want to order in restaurants, go shopping, or talk about food in English. All words include Spanish translations.'
            },
            {
                type: 'vocabulary',
                title: 'Vocabulary',
                table: [
                    {
                        word: 'Apple',
                        translation: 'Manzana',
                        pronunciation: 'ˈæp.əl',
                        example: 'I eat an apple every day.'
                    },
                    {
                        word: 'Bread',
                        translation: 'Pan',
                        pronunciation: 'bred',
                        example: 'We buy fresh bread every morning.'
                    },
                    {
                        word: 'Milk',
                        translation: 'Leche',
                        pronunciation: 'mɪlk',
                        example: 'Children drink milk to grow strong.'
                    },
                    {
                        word: 'Cheese',
                        translation: 'Queso',
                        pronunciation: 'tʃiːz',
                        example: 'This cheese is delicious.'
                    },
                    {
                        word: 'Water',
                        translation: 'Agua',
                        pronunciation: 'ˈwɔː.tər',
                        example: 'It is important to drink a lot of water.'
                    },
                    {
                        word: 'Coffee',
                        translation: 'Café',
                        pronunciation: 'ˈkɒf.i',
                        example: 'I drink coffee in the morning.'
                    },
                    {
                        word: 'Tea',
                        translation: 'Té',
                        pronunciation: 'tiː',
                        example: 'Would you like some tea?'
                    },
                    {
                        word: 'Sugar',
                        translation: 'Azúcar',
                        pronunciation: 'ˈʃʊɡ.ər',
                        example: 'I put sugar in my coffee.'
                    }
                ]
            },
            {
                type: 'exercises',
                title: 'Exercises',
                items: [
                    {
                        type: 'multiple_choice',
                        question: 'What does "pan" mean in English?',
                        options: ['Bread', 'Water', 'Cheese', 'Apple'],
                        correctAnswer: 0,
                        completeAnswer: 'Bread',
                        questionToSpeak: 'What does pan mean in English',
                        correctOptionText: 'Bread'
                    },
                    {
                        type: 'multiple_choice',
                        question: 'Complete the sentence: "I like to drink ___ every day."',
                        options: ['bread', 'cheese', 'water', 'apple'],
                        correctAnswer: 2,
                        completeAnswer: 'I like to drink water every day',
                        questionToSpeak: 'Complete the sentence I like to drink water every day',
                        correctOptionText: 'water'
                    },
                    {
                        type: 'true_false',
                        statement: '"Leche" means "Cheese" in English.',
                        correctAnswer: false,
                        explanation: '"Leche" means "Milk" in English. "Cheese" is "queso".',
                        completeAnswer: 'Leche means Milk not Cheese in English',
                        questionToSpeak: 'Leche means Cheese in English',
                        correctOptionText: 'False'
                    },
                    {
                        type: 'multiple_choice',
                        question: 'How do you say "café" in English?',
                        options: ['Tea', 'Coffee', 'Milk', 'Sugar'],
                        correctAnswer: 1,
                        completeAnswer: 'Coffee',
                        questionToSpeak: 'How do you say café in English',
                        correctOptionText: 'Coffee'
                    },
                    {
                        type: 'multiple_choice',
                        question: 'Which word means "azúcar" in English?',
                        options: ['Sugar', 'Salt', 'Pepper', 'Water'],
                        correctAnswer: 0,
                        completeAnswer: 'Sugar',
                        questionToSpeak: 'Which word means azúcar in English',
                        correctOptionText: 'Sugar'
                    }
                ]
            }
        ]
    }
];

// ==================== UTILIDADES ====================
const utils = {
    generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    
    isValidJson: (str) => {
        try {
            JSON.parse(str);
            return true;
        } catch {
            return false;
        }
    },
    
    copyToClipboard: async (text) => {
        try {
            await navigator.clipboard.writeText(text);
            return true;
        } catch {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            return true;
        }
    },
    
    cleanCorrectAnswer: (answer) => {
        if (!answer) return '';
        return answer
            .replace(/[^\w\sáéíóúüñÁÉÍÓÚÜÑ]/gi, ' ')
            .replace(/\d+/g, '')
            .replace(/\s+/g, ' ')
            .trim()
            .toLowerCase();
    },
    
    convertPromptFormatToInternalFormat: function(promptData) {
        let language = 'Inglés';
        if (promptData.lessonTitle?.includes('Español') || promptData.lessonTitle?.includes('Spanish')) {
            language = 'Español';
        } else if (promptData.lessonTitle?.includes('Francés') || promptData.lessonTitle?.includes('French')) {
            language = 'Francés';
        } else if (promptData.lessonTitle?.includes('Alemán') || promptData.lessonTitle?.includes('German')) {
            language = 'Alemán';
        } else if (promptData.lessonTitle?.includes('Italiano') || promptData.lessonTitle?.includes('Italian')) {
            language = 'Italiano';
        } else if (promptData.lessonTitle?.includes('Portugués') || promptData.lessonTitle?.includes('Portuguese')) {
            language = 'Portugués';
        }
        
        let level = promptData.level || 'Intermedio';
        const levelMap = {
            'beginner': 'Principiante',
            'intermediate': 'Intermedio',
            'advanced': 'Avanzado'
        };
        level = levelMap[level.toLowerCase()] || level;
        
        const sections = [];
        
        if (promptData.introduction) {
            sections.push({
                type: 'introduction',
                title: 'Introducción',
                content: promptData.introduction
            });
        }
        
        if (promptData.vocabulary?.length > 0) {
            sections.push({
                type: 'vocabulary',
                title: 'Vocabulario',
                table: promptData.vocabulary.map(item => ({
                    word: item.englishWord || item.word || item.targetWord || '',
                    translation: item.spanishTranslation || item.translation || item.nativeWord || '',
                    pronunciation: item.pronunciation || '',
                    example: item.example || item.usageExample || '',
                    partOfSpeech: item.partOfSpeech || 'Sustantivo',
                    synonyms: item.synonyms || ['similar'],
                    category: item.category || 'General'
                }))
            });
        }
        
        if (promptData.exercises?.length > 0) {
            sections.push({
                type: 'exercises',
                title: 'Ejercicios',
                items: promptData.exercises.map(exercise => {
                    if (exercise.type === 'multiple_choice' || exercise.exerciseType === 'multiple_choice') {
                        let correctAnswer = 0;
                        let correctOptionText = '';
                        if (exercise.options && exercise.correctOption) {
                            if (typeof exercise.correctOption === 'string') {
                                correctAnswer = exercise.options.findIndex(opt => 
                                    opt.toLowerCase() === exercise.correctOption.toLowerCase()
                                );
                                correctOptionText = exercise.correctOption;
                            } else {
                                correctAnswer = parseInt(exercise.correctOption);
                                correctOptionText = exercise.options[correctAnswer] || '';
                            }
                            if (correctAnswer === -1) correctAnswer = 0;
                        }
                        
                        return {
                            type: 'multiple_choice',
                            question: exercise.question || '',
                            options: exercise.options || [],
                            correctAnswer: correctAnswer,
                            completeAnswer: exercise.completeAnswer || '',
                            questionToSpeak: exercise.question || '',
                            correctOptionText: correctOptionText
                        };
                    } else if (exercise.type === 'true_false' || exercise.exerciseType === 'true_false') {
                        const correctAnswer = exercise.correctAnswer === true || exercise.correctAnswer === 'true';
                        const correctOptionText = correctAnswer ? 'Verdadero' : 'Falso';
                        
                        return {
                            type: 'true_false',
                            statement: exercise.statement || '',
                            correctAnswer: correctAnswer,
                            explanation: exercise.explanation || '',
                            completeAnswer: exercise.completeAnswer || '',
                            questionToSpeak: exercise.statement || '',
                            correctOptionText: correctOptionText
                        };
                    }
                    return null;
                }).filter(item => item !== null)
            });
        }
        
        return {
            id: this.generateId(),
            title: promptData.lessonTitle || 'Nueva Lección',
            language: language,
            level: level,
            topic: promptData.topic || 'General',
            tags: promptData.tags || [],
            estimatedTime: parseInt(promptData.duration) || 15,
            createdAt: new Date().toISOString(),
            author: 'Usuario',
            sections: sections
        };
    },
    
    extractWordsFromText: function(text) {
        if (!text) return [];
        return text.match(/\b[\w']+\b/g) || [];
    },
    
    isSignificantWord: function(word) {
        const stopWords = ['a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did'];
        return word.length > 2 && !stopWords.includes(word.toLowerCase());
    },
    
    getDictionaryLinks: function(word) {
        if (!word) return [];
        
        const encodedWord = encodeURIComponent(word.toLowerCase());
        
        return [
            {
                name: 'WordReference',
                url: `https://www.wordreference.com/es/translation.asp?tranword=${encodedWord}`,
                icon: 'fas fa-book',
                description: 'Diccionario multilingüe'
            },
            {
                name: 'Cambridge Dictionary',
                url: `https://dictionary.cambridge.org/dictionary/english/${encodedWord}`,
                icon: 'fas fa-university',
                description: 'Diccionario de inglés'
            },
            {
                name: 'Merriam-Webster',
                url: `https://www.merriam-webster.com/dictionary/${encodedWord}`,
                icon: 'fas fa-graduation-cap',
                description: 'Diccionario americano'
            },
            {
                name: 'Google Translate',
                url: `https://translate.google.com/?sl=en&tl=es&text=${encodedWord}&op=translate`,
                icon: 'fab fa-google',
                description: 'Traducción rápida'
            }
        ];
    },
    
    loadFavorites: function() {
        try {
            const saved = localStorage.getItem('openLingo_favorites');
            if (saved) {
                const favoriteIds = JSON.parse(saved);
                appState.favorites = new Set(favoriteIds);
                return true;
            }
        } catch (error) {
            console.error('Error al cargar favoritos:', error);
        }
        return false;
    },
    
    saveFavorites: function() {
        try {
            const favoriteIds = Array.from(appState.favorites);
            localStorage.setItem('openLingo_favorites', JSON.stringify(favoriteIds));
            return true;
        } catch (error) {
            console.error('Error al guardar favoritos:', error);
        }
        return false;
    },
    
    filterLessons: function(lessons, filters) {
        if (!lessons || !lessons.length) return [];
        
        return lessons.filter(lesson => {
            if (filters.search && filters.search.trim() !== '') {
                const searchTerm = filters.search.toLowerCase().trim();
                const titleMatch = lesson.title?.toLowerCase().includes(searchTerm);
                const topicMatch = lesson.topic?.toLowerCase().includes(searchTerm);
                const tagsMatch = Array.isArray(lesson.tags) ? 
                    lesson.tags.some(tag => tag.toLowerCase().includes(searchTerm)) : false;
                
                if (!titleMatch && !topicMatch && !tagsMatch) {
                    return false;
                }
            }
            
            if (filters.language && lesson.language !== filters.language) {
                return false;
            }
            
            if (filters.level && lesson.level !== filters.level) {
                return false;
            }
            
            if (filters.topic && lesson.topic !== filters.topic) {
                return false;
            }
            
            return true;
        });
    },
    
    extractUniqueTopics: function(lessons) {
        const topics = new Set();
        lessons.forEach(lesson => {
            if (lesson.topic) {
                topics.add(lesson.topic);
            }
            if (lesson.tags && Array.isArray(lesson.tags)) {
                lesson.tags.forEach(tag => topics.add(tag));
            }
        });
        return Array.from(topics).sort();
    },
    
    loadLessons: function() {
        try {
            const saved = localStorage.getItem('openLingo_lessons');
            if (saved) {
                const lessons = JSON.parse(saved);
                appState.allLessons = lessons;
            } else {
                appState.allLessons = [...defaultLessons];
                this.saveLessons();
            }
            return true;
        } catch (error) {
            console.error('Error al cargar lecciones:', error);
            appState.allLessons = [...defaultLessons];
            this.saveLessons();
            return false;
        }
    },
    
    saveLessons: function() {
        try {
            localStorage.setItem('openLingo_lessons', JSON.stringify(appState.allLessons));
            return true;
        } catch (error) {
            console.error('Error al guardar lecciones:', error);
        }
        return false;
    },
    
    addLesson: function(lesson) {
        if (!lesson.id) {
            lesson.id = this.generateId();
        }
        if (!lesson.createdAt) {
            lesson.createdAt = new Date().toISOString();
        }
        
        appState.allLessons.unshift(lesson);
        this.saveLessons();
        return lesson.id;
    }
};

// ==================== SISTEMA DE SONIDO ====================
class SoundSystem {
    constructor() {
        this.enabled = true;
        this.loadSettings();
        this.updateToggleButton();
    }
    
    play(type) {
        if (!this.enabled) return;
        
        try {
            switch(type) {
                case 'click':
                    this.playTone(800, 0.05);
                    break;
                case 'success':
                    this.playTone(523.25, 0.3);
                    setTimeout(() => this.playTone(659.25, 0.3), 100);
                    break;
                case 'error':
                    this.playTone(200, 0.3);
                    break;
                case 'complete':
                    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                        setTimeout(() => this.playTone(freq, 0.2), i * 100);
                    });
                    break;
                case 'start':
                    this.playTone(600, 0.1);
                    break;
                case 'stop':
                    this.playTone(400, 0.1);
                    break;
                case 'tts':
                    this.playTone(600, 0.1);
                    break;
            }
        } catch (e) {
            console.log('Audio no soportado');
        }
    }
    
    playTone(frequency, duration) {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.1;
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {}
    }
    
    toggle() {
        this.enabled = !this.enabled;
        this.saveSettings();
        this.updateToggleButton();
        this.play('click');
        return this.enabled;
    }
    
    loadSettings() {
        const saved = localStorage.getItem('openLingo_soundEnabled');
        this.enabled = saved !== null ? JSON.parse(saved) : true;
    }
    
    saveSettings() {
        localStorage.setItem('openLingo_soundEnabled', JSON.stringify(this.enabled));
    }
    
    updateToggleButton() {
        const toggleBtn = document.getElementById('sound-toggle');
        if (toggleBtn) {
            toggleBtn.classList.toggle('active', this.enabled);
            toggleBtn.innerHTML = this.enabled ? 
                '<i class="fas fa-volume-up"></i>' : 
                '<i class="fas fa-volume-mute"></i>';
        }
    }
}

// ==================== SISTEMA DE VOZ ====================
class VoiceSystem {
    constructor() {
        this.speechSynthesis = window.speechSynthesis || null;
        this.recognition = null;
        this.isListening = false;
        this.currentTextToCheck = '';
        this.currentExerciseIndex = null;
        this.currentPhase = null;
        this.rate = 1.0;
        this.currentVoice = null;
        
        this.initSpeechRecognition();
        this.initVoices();
        this.loadSettings();
    }
    
    initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.warn('Speech Recognition no disponible');
            return;
        }
        
        this.recognition = new SpeechRecognition();
        this.recognition.continuous = true;
        this.recognition.interimResults = false;
        this.recognition.lang = 'en-US';
        this.recognition.maxAlternatives = 1;
        
        this.recognition.onaudiostart = () => {
            console.log('🎤 Grabación iniciada');
        };
        
        this.recognition.onspeechend = () => {
            console.log('🔈 El usuario dejó de hablar');
        };
        
        this.recognition.onend = () => {
            console.log('⏹️ Grabación finalizada por sistema');
            this.isListening = false;
            this.updateVoiceButton(false);
        };
        
        this.recognition.onerror = (event) => {
            console.error('Error en reconocimiento:', event.error);
            this.isListening = false;
            this.updateVoiceButton(false);
        };
        
        this.recognition.onresult = (event) => {
            if (event.results.length > 0) {
                const transcript = event.results[event.results.length - 1][0].transcript;
                console.log('🗣️ Texto reconocido:', transcript);
                this.lastTranscript = transcript;
            }
        };
    }
    
    toggleListening(textToCheck, exerciseIndex, phase) {
        if (!this.recognition) {
            alert('El reconocimiento de voz no está disponible en tu navegador');
            return;
        }
        
        if (this.isListening) {
            this.stopListening();
            return;
        }
        
        if (!textToCheck || textToCheck.trim() === '') {
            soundSystem.play('error');
            alert(`No hay texto para pronunciar en la fase ${phase === 'pronounce-question' ? 'pronunciación de la pregunta' : 'pronunciación de la respuesta'}.`);
            return;
        }
        
        this.startListening(textToCheck, exerciseIndex, phase);
    }
    
    startListening(textToCheck, exerciseIndex, phase) {
        this.currentTextToCheck = textToCheck.toLowerCase();
        this.currentExerciseIndex = exerciseIndex;
        this.currentPhase = phase;
        this.lastTranscript = '';
        
        if (!this.currentTextToCheck || this.currentTextToCheck.trim() === '') {
            console.error('Texto vacío para verificar');
            soundSystem.play('error');
            return;
        }
        
        try {
            this.recognition.start();
            this.isListening = true;
            this.updateVoiceButton(true, phase);
            soundSystem.play('start');
            
            this.showRecordingIndicator(true, phase);
            
        } catch (error) {
            console.error('Error al iniciar grabación:', error);
            this.isListening = false;
            this.updateVoiceButton(false, phase);
            
            if (error.message.includes('already started')) {
                this.recognition.stop();
                setTimeout(() => this.startListening(textToCheck, exerciseIndex, phase), 100);
            }
        }
    }
    
    stopListening() {
        if (this.recognition && this.isListening) {
            console.log('⏹️ Deteniendo grabación por usuario...');
            this.recognition.stop();
            this.isListening = false;
            this.updateVoiceButton(false, this.currentPhase);
            soundSystem.play('stop');
            
            this.showRecordingIndicator(false);
            
            setTimeout(() => {
                if (this.lastTranscript) {
                    this.processVoiceInput(this.lastTranscript);
                } else {
                    console.log('No se capturó audio');
                    this.showNoAudioMessage();
                }
            }, 500);
        }
    }
    
    processVoiceInput(transcript) {
        const userAnswer = transcript.toLowerCase().trim();
        const correctText = utils.cleanCorrectAnswer(this.currentTextToCheck);
        
        console.log(`🎯 Comparando (Fase: ${this.currentPhase}):`, userAnswer, 'vs', correctText);
        
        if (!correctText || correctText.trim() === '') {
            console.error('Texto correcto vacío');
            soundSystem.play('error');
            this.showErrorFeedback('Error: No hay texto para comparar.');
            return;
        }
        
        const exerciseElement = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
        const feedbackDiv = exerciseElement?.querySelector('.feedback');
        
        if (!feedbackDiv) return;
        
        const isCorrect = this.isAnswerCorrect(userAnswer, correctText);
        
        if (isCorrect) {
            soundSystem.play('success');
            
            if (this.currentPhase === 'pronounce-question') {
                feedbackDiv.innerHTML = `
                    <div class="feedback-content">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>¡Perfecto! Has pronunciado correctamente la pregunta.</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">
                                Ahora puedes responder el ejercicio.
                            </div>
                        </div>
                    </div>
                `;
                feedbackDiv.className = 'feedback show correct';
                
                appState.exercisePhases[this.currentExerciseIndex] = 'answer';
                showExercisePhase(this.currentExerciseIndex);
                
            } else if (this.currentPhase === 'pronounce-answer') {
                feedbackDiv.innerHTML = `
                    <div class="feedback-content">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>¡Excelente! Pronunciación correcta.</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">
                                Ejercicio completado. Ahora puedes avanzar al siguiente.
                            </div>
                        </div>
                    </div>
                `;
                feedbackDiv.className = 'feedback show correct';
                
                appState.completedExercises.add(this.currentExerciseIndex);
                appState.exercisePhases[this.currentExerciseIndex] = 'completed';
                showExercisePhase(this.currentExerciseIndex);
                
                updateProgress();
                
                const nextBtn = document.querySelector('.next-exercise-btn');
                if (nextBtn) {
                    if (appState.currentExerciseIndex < appState.totalExercises - 1) {
                        nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Siguiente';
                        nextBtn.disabled = false;
                    } else {
                        nextBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> Completar';
                        nextBtn.disabled = false;
                    }
                }
            }
            
        } else {
            soundSystem.play('error');
            
            feedbackDiv.innerHTML = `
                <div class="feedback-content">
                    <i class="fas fa-times-circle"></i>
                    <div>
                        <strong>Intenta de nuevo</strong>
                        <div style="font-size: 0.9rem; margin-top: 4px;">
                            <div>Dijiste: <strong>"${userAnswer}"</strong></div>
                            <div>Debes decir: <strong>"${correctText}"</strong></div>
                        </div>
                    </div>
                </div>
            `;
            feedbackDiv.className = 'feedback show incorrect';
        }
    }
    
    showErrorFeedback(message) {
        const exerciseElement = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
        const feedbackDiv = exerciseElement?.querySelector('.feedback');
        
        if (feedbackDiv) {
            feedbackDiv.innerHTML = `
                <div class="feedback-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>${message}</strong>
                    </div>
                </div>
            `;
            feedbackDiv.className = 'feedback show incorrect';
        }
    }
    
    isAnswerCorrect(userAnswer, correctAnswer) {
        if (!correctAnswer || correctAnswer.trim() === '') {
            return false;
        }
        
        const commonWords = ['the', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'];
        const userWords = userAnswer.split(/\s+/).filter(word => !commonWords.includes(word));
        const correctWords = correctAnswer.split(/\s+/).filter(word => !commonWords.includes(word));
        
        if (userWords.length === 0 || correctWords.length === 0) return false;
        
        let matchCount = 0;
        userWords.forEach(userWord => {
            if (correctWords.some(correctWord => 
                userWord.includes(correctWord) || correctWord.includes(userWord) ||
                this.levenshteinDistance(userWord, correctWord) <= 2
            )) {
                matchCount++;
            }
        });
        
        const similarity = matchCount / Math.max(userWords.length, correctWords.length);
        return similarity >= 0.7;
    }
    
    levenshteinDistance(a, b) {
        const matrix = [];
        for (let i = 0; i <= b.length; i++) {
            matrix[i] = [i];
        }
        for (let j = 0; j <= a.length; j++) {
            matrix[0][j] = j;
        }
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }
    
    updateVoiceButton(listening, phase) {
        const exerciseElement = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
        if (!exerciseElement) return;
        
        let voiceBtn;
        if (phase === 'pronounce-question') {
            voiceBtn = exerciseElement.querySelector('.pronounce-question-btn');
        } else if (phase === 'pronounce-answer') {
            voiceBtn = exerciseElement.querySelector('.pronounce-answer-btn');
        }
        
        if (voiceBtn) {
            if (listening) {
                voiceBtn.innerHTML = '<i class="fas fa-stop-circle"></i> Detener';
                voiceBtn.classList.remove('btn-warning');
                voiceBtn.classList.add('btn-recording');
            } else {
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> Pronunciar';
                voiceBtn.classList.remove('btn-recording');
                voiceBtn.classList.add('btn-warning');
            }
        }
    }
    
    showRecordingIndicator(show, phase) {
        const exerciseElement = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
        if (!exerciseElement) return;
        
        const indicator = exerciseElement.querySelector('.recording-indicator');
        if (indicator) {
            if (show) {
                indicator.classList.add('active');
                indicator.innerHTML = `<i class="fas fa-circle" style="color: #dc2626; animation: pulse 1.5s infinite;"></i> Grabando... (${phase === 'pronounce-question' ? 'Pregunta' : 'Respuesta'})`;
            } else {
                indicator.classList.remove('active');
            }
        }
    }
    
    showNoAudioMessage() {
        const exerciseElement = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
        const feedbackDiv = exerciseElement?.querySelector('.feedback');
        
        if (feedbackDiv) {
            feedbackDiv.innerHTML = `
                <div class="feedback-content">
                    <i class="fas fa-microphone-slash"></i>
                    <div>
                        <strong>No se detectó audio</strong>
                        <div style="font-size: 0.9rem; margin-top: 4px;">
                            Asegúrate de hablar claro y tener el micrófono habilitado.
                        </div>
                    </div>
                </div>
            `;
            feedbackDiv.className = 'feedback show incorrect';
        }
    }
    
    speakText(text, language = 'inglés') {
        if (!this.speechSynthesis) return;
        
        this.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        if (this.currentVoice) {
            const selectedVoice = this.speechSynthesis.getVoices().find(v => v.name === this.currentVoice);
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
        }
        
        utterance.rate = this.rate;
        utterance.pitch = 1.0;
        utterance.volume = 1;
        
        const languageMap = {
            'inglés': 'en-US',
            'español': 'es-ES',
            'francés': 'fr-FR',
            'alemán': 'de-DE',
            'italiano': 'it-IT',
            'portugués': 'pt-PT'
        };
        
        utterance.lang = languageMap[language.toLowerCase()] || 'en-US';
        this.speechSynthesis.speak(utterance);
        
        soundSystem.play('tts');
    }
    
    initVoices() {
        if (!this.speechSynthesis) return;
        
        const loadVoices = () => {
            const voices = this.speechSynthesis.getVoices();
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));
            
            const voiceSelect = document.getElementById('tts-voice-select');
            if (!voiceSelect) return;
            
            voiceSelect.innerHTML = '';
            englishVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            if (this.currentVoice) {
                voiceSelect.value = this.currentVoice;
            }
        };
        
        if (this.speechSynthesis.onvoiceschanged !== undefined) {
            this.speechSynthesis.onvoiceschanged = loadVoices;
        }
        
        loadVoices();
    }
    
    loadSettings() {
        try {
            const saved = localStorage.getItem('openLingo_ttsSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                this.rate = settings.rate || 1.0;
                this.currentVoice = settings.voice || null;
            }
        } catch (error) {
            console.error('Error al cargar configuración TTS:', error);
        }
    }
    
    saveSettings() {
        try {
            const settings = {
                rate: this.rate,
                voice: this.currentVoice
            };
            localStorage.setItem('openLingo_ttsSettings', JSON.stringify(settings));
        } catch (error) {
            console.error('Error al guardar configuración TTS:', error);
        }
    }
}

// ==================== FUNCIONES DE INTERFAZ ====================
let soundSystem, voiceSystem;

function handleLanguageChange() {
    const languageSelect = document.getElementById('language');
    const otherLanguageGroup = document.getElementById('other-language-group');
    
    if (languageSelect.value === 'Otro') {
        otherLanguageGroup.classList.remove('hidden');
    } else {
        otherLanguageGroup.classList.add('hidden');
    }
}

function updateFilterOptions() {
    const topicFilter = document.getElementById('topic-filter');
    if (topicFilter) {
        const selectedValue = topicFilter.value;
        
        while (topicFilter.options.length > 1) {
            topicFilter.remove(1);
        }
        
        appState.availableTopics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            topicFilter.appendChild(option);
        });
        
        if (selectedValue && Array.from(appState.availableTopics).includes(selectedValue)) {
            topicFilter.value = selectedValue;
        }
    }
}

function applyFilters() {
    if (appState.activeTab === 'all-lessons') {
        appState.filteredLessons = utils.filterLessons(appState.allLessons, appState.activeFilters);
        displayLessons(appState.filteredLessons, 'lessons-list');
        
        const emptyState = document.getElementById('empty-lessons');
        const container = document.getElementById('lessons-list');
        
        if (appState.filteredLessons.length === 0) {
            emptyState.classList.remove('hidden');
            container.innerHTML = '';
        } else {
            emptyState.classList.add('hidden');
        }
        
    } else if (appState.activeTab === 'favorites') {
        const favoriteLessons = appState.allLessons.filter(lesson => 
            appState.favorites.has(lesson.id)
        );
        appState.filteredFavorites = utils.filterLessons(favoriteLessons, appState.favoriteFilters);
        
        displayLessons(appState.filteredFavorites, 'favorites-list');
        
        const emptyState = document.getElementById('empty-favorites');
        const container = document.getElementById('favorites-list');
        
        if (appState.filteredFavorites.length === 0) {
            emptyState.classList.remove('hidden');
            container.innerHTML = '';
        } else {
            emptyState.classList.add('hidden');
        }
    }
    
    updateCounters();
}

function updateActiveFiltersDisplay() {
    const activeFiltersContainer = document.getElementById('active-filters');
    if (!activeFiltersContainer) return;
    
    activeFiltersContainer.innerHTML = '';
    
    const filters = appState.activeFilters;
    let hasActiveFilters = false;
    
    if (filters.language) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag active';
        filterTag.innerHTML = `Idioma: ${filters.language} <i class="fas fa-times" style="margin-left: 4px; cursor: pointer;" data-filter="language"></i>`;
        filterTag.addEventListener('click', (e) => {
            if (e.target.closest('i')) {
                document.getElementById('language-filter').value = '';
                appState.activeFilters.language = '';
                applyFilters();
                updateActiveFiltersDisplay();
            }
        });
        activeFiltersContainer.appendChild(filterTag);
        hasActiveFilters = true;
    }
    
    if (filters.level) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag active';
        filterTag.innerHTML = `Nivel: ${filters.level} <i class="fas fa-times" style="margin-left: 4px; cursor: pointer;" data-filter="level"></i>`;
        filterTag.addEventListener('click', (e) => {
            if (e.target.closest('i')) {
                document.getElementById('level-filter').value = '';
                appState.activeFilters.level = '';
                applyFilters();
                updateActiveFiltersDisplay();
            }
        });
        activeFiltersContainer.appendChild(filterTag);
        hasActiveFilters = true;
    }
    
    if (filters.topic) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag active';
        filterTag.innerHTML = `Tema: ${filters.topic} <i class="fas fa-times" style="margin-left: 4px; cursor: pointer;" data-filter="topic"></i>`;
        filterTag.addEventListener('click', (e) => {
            if (e.target.closest('i')) {
                document.getElementById('topic-filter').value = '';
                appState.activeFilters.topic = '';
                applyFilters();
                updateActiveFiltersDisplay();
            }
        });
        activeFiltersContainer.appendChild(filterTag);
        hasActiveFilters = true;
    }
    
    if (filters.search) {
        const filterTag = document.createElement('span');
        filterTag.className = 'filter-tag active';
        filterTag.innerHTML = `Buscar: "${filters.search}" <i class="fas fa-times" style="margin-left: 4px; cursor: pointer;" data-filter="search"></i>`;
        filterTag.addEventListener('click', (e) => {
            if (e.target.closest('i')) {
                document.getElementById('search-input').value = '';
                appState.activeFilters.search = '';
                applyFilters();
                updateActiveFiltersDisplay();
            }
        });
        activeFiltersContainer.appendChild(filterTag);
        hasActiveFilters = true;
    }
    
    if (hasActiveFilters) {
        const clearAllBtn = document.createElement('button');
        clearAllBtn.className = 'btn btn-small btn-secondary';
        clearAllBtn.innerHTML = '<i class="fas fa-times"></i> Limpiar todos';
        clearAllBtn.addEventListener('click', () => {
            document.getElementById('language-filter').value = '';
            document.getElementById('level-filter').value = '';
            document.getElementById('topic-filter').value = '';
            document.getElementById('search-input').value = '';
            
            appState.activeFilters = {
                language: '',
                level: '',
                topic: '',
                search: ''
            };
            
            applyFilters();
            updateActiveFiltersDisplay();
        });
        activeFiltersContainer.appendChild(clearAllBtn);
    }
}

function updateCounters() {
    const allLessonsCount = document.getElementById('all-lessons-count');
    if (allLessonsCount) {
        allLessonsCount.textContent = appState.allLessons.length;
    }
    
    const favoritesCount = document.getElementById('favorites-count');
    if (favoritesCount) {
        favoritesCount.textContent = appState.favorites.size;
    }
    
    const lessonsCount = document.getElementById('lessons-count');
    if (lessonsCount) {
        const totalLessons = appState.allLessons.length;
        const totalFavorites = appState.favorites.size;
        lessonsCount.textContent = `${totalLessons} lección${totalLessons !== 1 ? 'es' : ''} (${totalFavorites} favorito${totalFavorites !== 1 ? 's' : ''})`;
    }
}

function displayLessons(lessons, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!lessons || lessons.length === 0) {
        return;
    }
    
    lessons.forEach(lesson => {
        const exerciseCount = lesson.sections?.find(s => s.type === 'exercises')?.items?.length || 0;
        const isFavorite = appState.favorites.has(lesson.id);
        
        const card = document.createElement('div');
        card.className = 'lesson-card';
        card.innerHTML = `
            <div class="favorite-btn ${isFavorite ? 'favorited' : ''}" data-lesson-id="${lesson.id}" title="${isFavorite ? 'Quitar de favoritos' : 'Agregar a favoritos'}">
                <i class="fas fa-heart"></i>
            </div>
            
            <div class="lesson-header">
                <div>
                    <div class="lesson-title">${lesson.title}</div>
                    <div class="lesson-tags" style="margin-top: 8px;">
                        <span class="lesson-tag">${lesson.language}</span>
                        ${lesson.level ? `<span class="lesson-tag-small">${lesson.level}</span>` : ''}
                        ${lesson.topic ? `<span class="lesson-tag-small">${lesson.topic}</span>` : ''}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; color: var(--gray-color);">${exerciseCount} ejercicios</div>
                </div>
            </div>
            
            <div class="lesson-meta">
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span>${lesson.estimatedTime || 15} min</span>
                    <i class="fas fa-calendar-alt"></i>
                    <span>${new Date(lesson.createdAt).toLocaleDateString()}</span>
                </div>
            </div>
            
            <button class="btn btn-primary view-lesson-btn" data-id="${lesson.id}" style="width: 100%;">
                <i class="fas fa-play"></i> Comenzar
            </button>
        `;
        
        const favoriteBtn = card.querySelector('.favorite-btn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFavorite(lesson.id);
            });
        }
        
        const viewLessonBtn = card.querySelector('.view-lesson-btn');
        if (viewLessonBtn) {
            viewLessonBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                viewLesson(lesson);
            });
        }
        
        container.appendChild(card);
    });
}

function toggleFavorite(lessonId) {
    soundSystem.play('click');
    
    if (appState.favorites.has(lessonId)) {
        appState.favorites.delete(lessonId);
    } else {
        appState.favorites.add(lessonId);
    }
    
    utils.saveFavorites();
    
    if (appState.activeTab === 'favorites') {
        applyFilters();
    } else {
        const favoriteBtn = document.querySelector(`.favorite-btn[data-lesson-id="${lessonId}"]`);
        if (favoriteBtn) {
            const isFavorite = appState.favorites.has(lessonId);
            favoriteBtn.classList.toggle('favorited', isFavorite);
            favoriteBtn.title = isFavorite ? 'Quitar de favoritos' : 'Agregar a favoritos';
        }
    }
    
    updateCounters();
}

function switchTab(tabId) {
    soundSystem.play('click');
    
    appState.activeTab = tabId;
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add('active');
    document.getElementById(`${tabId}-tab`)?.classList.add('active');
    
    applyFilters();
}

function viewLesson(lesson) {
    if (!lesson) return;
    
    appState.currentLesson = lesson;
    appState.currentExerciseIndex = 0;
    appState.completedExercises.clear();
    appState.exercisePhases = {};
    
    const exerciseSection = lesson.sections?.find(s => s.type === 'exercises');
    appState.totalExercises = exerciseSection?.items?.length || 0;
    
    for (let i = 0; i < appState.totalExercises; i++) {
        appState.exercisePhases[i] = 'pronounce-question';
    }
    
    document.getElementById('lesson-title').textContent = lesson.title;
    const content = document.getElementById('lesson-content');
    content.innerHTML = '';
    
    let lessonHTML = '';
    
    lesson.sections.forEach(section => {
        if (section.type === 'introduction') {
            lessonHTML += createIntroductionSection(section);
        } else if (section.type === 'vocabulary' && section.table?.length > 0) {
            lessonHTML += createVocabularySection(section, lesson.language);
        }
    });
    
    lessonHTML += `
        <div class="start-exercises-btn" id="start-exercises-section">
            <h3><i class="fas fa-play-circle"></i> ¿Listo para practicar?</h3>
            <p style="color: var(--gray-color); margin-bottom: 20px;">
                Has revisado la introducción y el vocabulario. Ahora es tiempo de poner en práctica lo aprendido.
            </p>
            <button class="btn btn-primary" id="start-exercises-btn">
                <i class="fas fa-play"></i> Comenzar Ejercicios
            </button>
        </div>
        
        <div id="exercises-container" class="hidden"></div>
    `;
    
    content.innerHTML = lessonHTML;
    
    applyClickableTTS();
    
    document.getElementById('start-exercises-btn')?.addEventListener('click', function() {
        soundSystem.play('click');
        startExercises(lesson);
    });
    
    document.getElementById('lesson-modal').classList.add('active');
}

function createIntroductionSection(section) {
    let content = processTextForTTS(section.content);
    
    return `
        <div class="lesson-section" id="introduction-section">
            <div class="lesson-section-header">
                <h3><i class="fas fa-info-circle"></i> ${section.title}</h3>
            </div>
            <div class="exercise-question" style="line-height: 1.7;">
                ${content}
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-secondary" onclick="readAloudSection('${section.content.replace(/'/g, "\\'")}', '${appState.currentLesson?.language || 'Inglés'}')">
                    <i class="fas fa-volume-up"></i> Escuchar
                </button>
            </div>
        </div>
    `;
}

function createVocabularySection(section, language) {
    let tableHTML = '';
    
    if (section.table?.length > 0) {
        appState.quickReferenceData = {};
        
        tableHTML = `
            <div class="vocabulary-table-container">
                <table class="vocabulary-table">
                    <thead>
                        <tr>
                            <th>Palabra</th>
                            <th>Traducción</th>
                            <th>Pronunciación</th>
                            <th>Ejemplo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${section.table.map((item, index) => {
                            const wordId = `word-${index}`;
                            
                            appState.quickReferenceData[wordId] = {
                                word: item.word || '',
                                translation: item.translation || '-',
                                pronunciation: item.pronunciation || '-',
                                example: item.example || '-',
                                language: language
                            };
                            
                            let exampleHTML = '-';
                            if (item.example) {
                                exampleHTML = processTextForTTS(item.example);
                            }
                            
                            return `
                                <tr>
                                    <td class="clickable-text" 
                                        data-word-id="${wordId}" 
                                        data-word="${item.word || ''}" 
                                        data-label="Palabra"
                                        style="font-weight: 600;">
                                        <span>${item.word || '-'}</span>
                                    </td>
                                    <td data-label="Traducción">
                                        <span>${item.translation || '-'}</span>
                                    </td>
                                    <td data-label="Pronunciación">
                                        <em>${item.pronunciation || '-'}</em>
                                    </td>
                                    <td data-label="Ejemplo" style="font-size: 0.9rem;">
                                        <div>${exampleHTML}</div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    return `
        <div class="lesson-section" id="vocabulary-section">
            <div class="lesson-section-header">
                <h3><i class="fas fa-list-ul"></i> ${section.title}</h3>
                <button class="btn btn-secondary btn-small" onclick="readAloudVocabularyTable()">
                    <i class="fas fa-volume-up"></i> Escuchar Todo
                </button>
            </div>
            ${tableHTML}
            <div class="text-center mt-4">
                <p style="color: var(--gray-color); font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> Haz clic en cualquier palabra para escuchar su pronunciación y buscar en diccionarios.
                </p>
            </div>
        </div>
    `;
}

function processTextForTTS(text) {
    if (!text) return '';
    
    const words = utils.extractWordsFromText(text);
    const uniqueWords = [...new Set(words)];
    
    let processedText = text;
    
    uniqueWords.forEach(word => {
        if (utils.isSignificantWord(word)) {
            const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`\\b${escapedWord}\\b`, 'g');
            processedText = processedText.replace(regex, `<span class="clickable-text" data-word="${word}">${word}</span>`);
        }
    });
    
    return processedText;
}

function startExercises(lesson) {
    const exercisesContainer = document.getElementById('exercises-container');
    const startSection = document.getElementById('start-exercises-section');
    
    startSection.classList.add('hidden');
    
    const introductionSection = document.getElementById('introduction-section');
    const vocabularySection = document.getElementById('vocabulary-section');
    
    if (introductionSection) {
        introductionSection.classList.add('hidden');
    }
    
    if (vocabularySection) {
        vocabularySection.classList.add('hidden');
    }
    
    exercisesContainer.classList.remove('hidden');
    
    let exercisesHTML = '';
    
    const exerciseSection = lesson.sections?.find(s => s.type === 'exercises');
    if (exerciseSection?.items?.length > 0) {
        exerciseSection.items.forEach((item, index) => {
            const questionToSpeak = utils.cleanCorrectAnswer(item.questionToSpeak || item.question || item.statement || '');
            
            let answerToSpeak = '';
            
            if (item.type === 'multiple_choice') {
                answerToSpeak = utils.cleanCorrectAnswer(item.correctOptionText || (item.options ? item.options[item.correctAnswer] : ''));
            } else if (item.type === 'true_false') {
                answerToSpeak = utils.cleanCorrectAnswer(item.correctOptionText || (item.correctAnswer ? 'Verdadero' : 'Falso'));
            }
            
            const hasQuestionText = questionToSpeak && questionToSpeak.trim() !== '';
            const hasAnswerText = answerToSpeak && answerToSpeak.trim() !== '';
            
            let exerciseContent = '';
            
            if (item.type === 'multiple_choice') {
                let question = processTextForTTS(item.question || '');
                
                exerciseContent = `
                    <div class="exercise-phase pronounce-question-phase" data-phase="pronounce-question">
                        <div class="pronunciation-section">
                            <div class="pronunciation-header">
                                <i class="fas fa-microphone"></i>
                                <h5>Paso 1: Pronuncia la pregunta</h5>
                            </div>
                            <div class="pronunciation-text">
                                ${hasQuestionText ? questionToSpeak : '<span style="color: var(--danger-color);">Texto no disponible</span>'}
                            </div>
                            <div class="recording-indicator"></div>
                            <div class="pronunciation-controls">
                                <button class="btn btn-warning pronounce-question-btn" 
                                        data-exercise-index="${index}" 
                                        data-text="${hasQuestionText ? questionToSpeak.replace(/"/g, '&quot;') : ''}"
                                        ${!hasQuestionText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-microphone"></i> Pronunciar
                                </button>
                                <button class="btn btn-secondary listen-question-btn" 
                                        data-text="${hasQuestionText ? questionToSpeak.replace(/"/g, '&quot;') : ''}" 
                                        data-language="${lesson.language}"
                                        ${!hasQuestionText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-volume-up"></i> Escuchar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="exercise-phase answer-phase hidden" data-phase="answer">
                        <div class="exercise-question">${question}</div>
                        <div class="exercise-options" data-exercise-index="${index}" id="options-${index}">
                            ${item.options?.map((option, optIndex) => `
                                <label class="option-label" data-option="${optIndex}">
                                    <input type="radio" name="exercise-${index}" value="${optIndex}" style="display: none;">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                        <button class="btn btn-success check-answer-btn" style="width: 100%; margin-top: 16px;" id="check-btn-${index}">
                            <i class="fas fa-check"></i> Verificar
                        </button>
                    </div>
                    
                    <div class="exercise-phase pronounce-answer-phase hidden" data-phase="pronounce-answer">
                        <div class="pronunciation-section">
                            <div class="pronunciation-header">
                                <i class="fas fa-microphone"></i>
                                <h5>Paso 3: Pronuncia la respuesta correcta</h5>
                            </div>
                            <div class="pronunciation-text">
                                ${hasAnswerText ? 
                                    `<span style="color: var(--primary-color); font-weight: 600;">${answerToSpeak}</span>` : 
                                    '<span style="color: var(--danger-color);">Texto no disponible</span>'}
                            </div>
                            <div class="recording-indicator"></div>
                            <div class="pronunciation-controls">
                                <button class="btn btn-warning pronounce-answer-btn" 
                                        data-exercise-index="${index}" 
                                        data-text="${hasAnswerText ? answerToSpeak.replace(/"/g, '&quot;') : ''}"
                                        ${!hasAnswerText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-microphone"></i> Pronunciar
                                </button>
                                <button class="btn btn-secondary listen-answer-btn" 
                                        data-text="${hasAnswerText ? answerToSpeak.replace(/"/g, '&quot;') : ''}" 
                                        data-language="${lesson.language}"
                                        ${!hasAnswerText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-volume-up"></i> Escuchar
                                </button>
                            </div>
                            <div style="margin-top: 12px; font-size: 0.85rem; color: var(--gray-color);">
                                <i class="fas fa-info-circle"></i> Solo debes decir: <strong>"${hasAnswerText ? answerToSpeak : 'Texto no disponible'}"</strong>
                            </div>
                        </div>
                    </div>
                `;
            } else if (item.type === 'true_false') {
                let statement = processTextForTTS(item.statement || '');
                
                exerciseContent = `
                    <div class="exercise-phase pronounce-question-phase" data-phase="pronounce-question">
                        <div class="pronunciation-section">
                            <div class="pronunciation-header">
                                <i class="fas fa-microphone"></i>
                                <h5>Paso 1: Pronuncia la afirmación</h5>
                            </div>
                            <div class="pronunciation-text">
                                ${hasQuestionText ? questionToSpeak : '<span style="color: var(--danger-color);">Texto no disponible</span>'}
                            </div>
                            <div class="recording-indicator"></div>
                            <div class="pronunciation-controls">
                                <button class="btn btn-warning pronounce-question-btn" 
                                        data-exercise-index="${index}" 
                                        data-text="${hasQuestionText ? questionToSpeak.replace(/"/g, '&quot;') : ''}"
                                        ${!hasQuestionText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-microphone"></i> Pronunciar
                                </button>
                                <button class="btn btn-secondary listen-question-btn" 
                                        data-text="${hasQuestionText ? questionToSpeak.replace(/"/g, '&quot;') : ''}" 
                                        data-language="${lesson.language}"
                                        ${!hasQuestionText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-volume-up"></i> Escuchar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="exercise-phase answer-phase hidden" data-phase="answer">
                        <div class="exercise-question">${statement}</div>
                        <div class="exercise-options" data-exercise-index="${index}" id="options-${index}">
                            <label class="option-label" data-option="true">
                                <input type="radio" name="exercise-${index}" value="true" style="display: none;">
                                <span>Verdadero</span>
                            </label>
                            <label class="option-label" data-option="false">
                                <input type="radio" name="exercise-${index}" value="false" style="display: none;">
                                <span>Falso</span>
                            </label>
                        </div>
                        <button class="btn btn-success check-answer-btn" style="width: 100%; margin-top: 16px;" id="check-btn-${index}">
                            <i class="fas fa-check"></i> Verificar
                        </button>
                    </div>
                    
                    <div class="exercise-phase pronounce-answer-phase hidden" data-phase="pronounce-answer">
                        <div class="pronunciation-section">
                            <div class="pronunciation-header">
                                <i class="fas fa-microphone"></i>
                                <h5>Paso 3: Pronuncia la respuesta correcta</h5>
                            </div>
                            <div class="pronunciation-text">
                                ${hasAnswerText ? 
                                    `<span style="color: var(--primary-color); font-weight: 600;">${answerToSpeak}</span>` : 
                                    '<span style="color: var(--danger-color);">Texto no disponible</span>'}
                            </div>
                            <div class="recording-indicator"></div>
                            <div class="pronunciation-controls">
                                <button class="btn btn-warning pronounce-answer-btn" 
                                        data-exercise-index="${index}" 
                                        data-text="${hasAnswerText ? answerToSpeak.replace(/"/g, '&quot;') : ''}"
                                        ${!hasAnswerText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-microphone"></i> Pronunciar
                                </button>
                                <button class="btn btn-secondary listen-answer-btn" 
                                        data-text="${hasAnswerText ? answerToSpeak.replace(/"/g, '&quot;') : ''}" 
                                        data-language="${lesson.language}"
                                        ${!hasAnswerText ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-volume-up"></i> Escuchar
                                </button>
                            </div>
                            <div style="margin-top: 12px; font-size: 0.85rem; color: var(--gray-color);">
                                <i class="fas fa-info-circle"></i> Solo debes decir: <strong>"${hasAnswerText ? answerToSpeak : 'Texto no disponible'}"</strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            exerciseContent += `
                <div class="feedback" id="feedback-${index}"></div>
            `;
            
            exercisesHTML += `
                <div class="exercise ${index === 0 ? 'current' : 'hidden'}" 
                     data-exercise-index="${index}" 
                     data-exercise-type="${item.type}"
                     data-correct-answer="${item.type === 'multiple_choice' ? item.correctAnswer : item.correctAnswer}">
                    <h4><i class="fas fa-question-circle"></i> Ejercicio ${index + 1}</h4>
                    ${exerciseContent}
                </div>
            `;
        });
    }
    
    exercisesHTML += `
        <div class="lesson-progress" style="margin-top: 24px;">
            <div class="progress-info">
                <span>Progreso</span>
                <span>Ejercicio <span id="current-exercise">1</span> de ${appState.totalExercises}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-navigation">
                <button class="btn btn-secondary prev-exercise-btn" style="flex: 1;">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary next-exercise-btn" style="flex: 2;" disabled>
                    <i class="fas fa-lock"></i> Completa todos los pasos
                </button>
            </div>
        </div>
    `;
    
    exercisesContainer.innerHTML = exercisesHTML;
    
    applyClickableTTS();
    showExercisePhase(appState.currentExerciseIndex);
    initLessonEvents();
    updateProgress();
}

function showExercisePhase(exerciseIndex) {
    const exerciseElement = document.querySelector(`[data-exercise-index="${exerciseIndex}"]`);
    if (!exerciseElement) return;
    
    const currentPhase = appState.exercisePhases[exerciseIndex];
    
    exerciseElement.querySelectorAll('.exercise-phase').forEach(phase => {
        phase.classList.add('hidden');
    });
    
    if (currentPhase === 'pronounce-question') {
        exerciseElement.querySelector('.pronounce-question-phase')?.classList.remove('hidden');
    } else if (currentPhase === 'answer') {
        exerciseElement.querySelector('.answer-phase')?.classList.remove('hidden');
    } else if (currentPhase === 'pronounce-answer') {
        exerciseElement.querySelector('.pronounce-answer-phase')?.classList.remove('hidden');
    } else if (currentPhase === 'completed') {
        let completionMessage = exerciseElement.querySelector('.completion-message');
        if (!completionMessage) {
            completionMessage = document.createElement('div');
            completionMessage.className = 'completion-message text-center';
            completionMessage.style.cssText = 'padding: 30px 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--border-radius); margin-top: 16px;';
            completionMessage.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--secondary-color); margin-bottom: 12px;"></i>
                <h4 style="color: var(--secondary-color); margin-bottom: 12px; font-size: 1.1rem;">¡Ejercicio Completado!</h4>
                <p style="color: var(--gray-color); font-size: 0.9rem;">Has terminado todos los pasos de este ejercicio.</p>
                <button class="btn btn-success mt-4" onclick="document.querySelector('.next-exercise-btn')?.click()">
                    <i class="fas fa-arrow-right"></i> Continuar
                </button>
            `;
            
            exerciseElement.querySelectorAll('.exercise-phase').forEach(phase => {
                phase.style.display = 'none';
            });
            exerciseElement.appendChild(completionMessage);
        }
        
        completionMessage.style.display = 'block';
        
        setTimeout(() => {
            updateProgress();
        }, 100);
    }
}

function initLessonEvents() {
    document.querySelector('.prev-exercise-btn')?.addEventListener('click', () => {
        if (appState.currentExerciseIndex > 0) {
            appState.currentExerciseIndex--;
            showExercise(appState.currentExerciseIndex);
            showExercisePhase(appState.currentExerciseIndex);
            soundSystem.play('click');
        }
    });
    
    document.querySelector('.next-exercise-btn')?.addEventListener('click', () => {
        if (appState.currentExerciseIndex < appState.totalExercises - 1) {
            appState.currentExerciseIndex++;
            showExercise(appState.currentExerciseIndex);
            showExercisePhase(appState.currentExerciseIndex);
            soundSystem.play('click');
        } else {
            soundSystem.play('complete');
            setTimeout(() => {
                if (confirm('¡Felicidades! Has completado la lección. ¿Deseas cerrarla?')) {
                    document.getElementById('lesson-modal').classList.remove('active');
                }
            }, 500);
        }
    });
    
    document.getElementById('exercises-container').addEventListener('click', function(e) {
        const optionLabel = e.target.closest('.option-label');
        if (optionLabel) {
            const container = optionLabel.closest('.exercise-options');
            const exerciseIndex = parseInt(container.dataset.exerciseIndex);
            
            if (appState.exercisePhases[exerciseIndex] !== 'answer') {
                soundSystem.play('error');
                return;
            }
            
            container.querySelectorAll('.option-label').forEach(l => {
                l.classList.remove('selected');
            });
            optionLabel.classList.add('selected');
            
            const radio = optionLabel.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
            }
            soundSystem.play('click');
            e.stopPropagation();
        }
    });
    
    document.getElementById('exercises-container').addEventListener('click', function(e) {
        const checkBtn = e.target.closest('.check-answer-btn');
        if (checkBtn) {
            const exercise = checkBtn.closest('.exercise');
            const index = parseInt(exercise.dataset.exerciseIndex);
            const type = exercise.dataset.exerciseType;
            const correctAnswer = exercise.dataset.correctAnswer;
            const selectedOption = exercise.querySelector('.option-label.selected');
            
            if (!selectedOption) {
                soundSystem.play('error');
                alert('Primero selecciona una respuesta.');
                return;
            }
            
            const selectedValue = selectedOption.dataset.option;
            const isCorrect = type === 'multiple_choice' ? 
                parseInt(selectedValue) === parseInt(correctAnswer) : 
                selectedValue === correctAnswer;
            
            const feedback = document.getElementById(`feedback-${index}`);
            
            if (isCorrect) {
                soundSystem.play('success');
                selectedOption.classList.add('correct');
                
                appState.exercisePhases[index] = 'pronounce-answer';
                showExercisePhase(index);
                
                feedback.innerHTML = `
                    <div class="feedback-content">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>¡Respuesta correcta!</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">Ahora pronuncia la respuesta correcta.</div>
                        </div>
                    </div>
                `;
                feedback.className = 'feedback show correct';
            } else {
                soundSystem.play('error');
                selectedOption.classList.add('incorrect');
                feedback.innerHTML = `
                    <div class="feedback-content">
                        <i class="fas fa-times-circle"></i>
                        <div>
                            <strong>Respuesta incorrecta</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">Intenta seleccionar otra opción.</div>
                        </div>
                    </div>
                `;
                feedback.className = 'feedback show incorrect';
            }
            e.stopPropagation();
        }
    });
    
    document.getElementById('exercises-container').addEventListener('click', function(e) {
        const pronounceQuestionBtn = e.target.closest('.pronounce-question-btn');
        if (pronounceQuestionBtn) {
            const index = parseInt(pronounceQuestionBtn.dataset.exerciseIndex);
            const text = pronounceQuestionBtn.dataset.text;
            
            voiceSystem.toggleListening(text, index, 'pronounce-question');
            e.stopPropagation();
            return;
        }
        
        const pronounceAnswerBtn = e.target.closest('.pronounce-answer-btn');
        if (pronounceAnswerBtn) {
            const index = parseInt(pronounceAnswerBtn.dataset.exerciseIndex);
            const text = pronounceAnswerBtn.dataset.text;
            
            if (appState.exercisePhases[index] !== 'pronounce-answer') {
                soundSystem.play('error');
                alert('Primero debes contestar el ejercicio correctamente.');
                return;
            }
            
            if (!text || text.trim() === '') {
                soundSystem.play('error');
                alert('No hay texto disponible para pronunciar la respuesta.');
                return;
            }
            
            voiceSystem.toggleListening(text, index, 'pronounce-answer');
            e.stopPropagation();
            return;
        }
        
        const listenQuestionBtn = e.target.closest('.listen-question-btn');
        if (listenQuestionBtn) {
            const text = listenQuestionBtn.dataset.text;
            const language = listenQuestionBtn.dataset.language;
            
            if (!text || text.trim() === '') {
                soundSystem.play('error');
                alert('No hay texto disponible para escuchar.');
                return;
            }
            
            soundSystem.play('click');
            voiceSystem.speakText(text, language);
            e.stopPropagation();
            return;
        }
        
        const listenAnswerBtn = e.target.closest('.listen-answer-btn');
        if (listenAnswerBtn) {
            const text = listenAnswerBtn.dataset.text;
            const language = listenAnswerBtn.dataset.language;
            
            if (!text || text.trim() === '') {
                soundSystem.play('error');
                alert('No hay texto disponible para escuchar.');
                return;
            }
            
            soundSystem.play('click');
            voiceSystem.speakText(text, language);
            e.stopPropagation();
            return;
        }
    });
}

function showExercise(index) {
    document.querySelectorAll('.exercise').forEach(ex => {
        ex.classList.add('hidden');
        ex.classList.remove('current');
    });
    
    const currentExercise = document.querySelector(`[data-exercise-index="${index}"]`);
    if (currentExercise) {
        currentExercise.classList.remove('hidden');
        currentExercise.classList.add('current');
    }
    
    appState.currentExerciseIndex = index;
    updateProgress();
}

function updateProgress() {
    const progressFill = document.getElementById('progress-fill');
    const currentExerciseText = document.getElementById('current-exercise');
    const prevBtn = document.querySelector('.prev-exercise-btn');
    const nextBtn = document.querySelector('.next-exercise-btn');
    
    if (progressFill) {
        const progress = ((appState.currentExerciseIndex + 1) / appState.totalExercises) * 100;
        progressFill.style.width = `${progress}%`;
    }
    
    if (currentExerciseText) {
        currentExerciseText.textContent = appState.currentExerciseIndex + 1;
    }
    
    if (prevBtn) {
        prevBtn.disabled = appState.currentExerciseIndex === 0;
    }
    
    if (nextBtn) {
        const isCurrentExerciseCompleted = appState.exercisePhases[appState.currentExerciseIndex] === 'completed';
        
        nextBtn.disabled = !isCurrentExerciseCompleted;
        
        if (appState.currentExerciseIndex < appState.totalExercises - 1) {
            if (isCurrentExerciseCompleted) {
                nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Siguiente';
                nextBtn.disabled = false;
            } else {
                nextBtn.innerHTML = '<i class="fas fa-lock"></i> Completa todos los pasos';
                nextBtn.disabled = true;
            }
        } else {
            nextBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> Completar';
            nextBtn.disabled = !isCurrentExerciseCompleted;
        }
    }
}

function applyClickableTTS() {
    document.querySelectorAll('.clickable-text').forEach(el => {
        el.replaceWith(el.cloneNode(true));
    });
    
    document.querySelectorAll('.clickable-text').forEach(el => {
        if (!appState.ttsEnabled) {
            el.classList.add('tts-disabled');
        } else {
            el.classList.remove('tts-disabled');
        }
        
        el.addEventListener('click', function(e) {
            if (!appState.ttsEnabled) return;
            
            soundSystem.play('click');
            
            const word = this.dataset.word;
            const wordId = this.dataset.wordId;
            
            if (word && wordId && appState.quickReferenceData[wordId]) {
                const wordData = appState.quickReferenceData[wordId];
                const language = wordData.language || appState.currentLesson?.language || 'Inglés';
                
                const wordToSpeak = word || wordData.word;
                voiceSystem.speakText(wordToSpeak, language);
                
                showQuickReference(wordToSpeak, language);
            } else if (word) {
                const language = appState.currentLesson?.language || 'Inglés';
                voiceSystem.speakText(word, language);
                showQuickReference(word, language);
            }
            
            e.stopPropagation();
        });
    });
}

function showQuickReference(word, language) {
    appState.currentWord = word;
    
    document.getElementById('quick-reference-word').innerHTML = `
        ${word}
        <button class="btn btn-icon" onclick="playCurrentWord()" style="background: transparent; color: var(--primary-color);">
            <i class="fas fa-volume-up"></i>
        </button>
    `;
    
    const dictionaryLinks = utils.getDictionaryLinks(word);
    const linksHTML = dictionaryLinks.map(dict => `
        <a href="${dict.url}" target="_blank" class="dictionary-link">
            <div class="dictionary-name">
                <div class="dictionary-icon">${dict.icon.startsWith('fab') ? `<i class="${dict.icon}"></i>` : `<i class="${dict.icon}"></i>`}</div>
                <span>${dict.name}</span>
            </div>
            <div>
                <span style="font-size: 0.85rem; color: var(--gray-color); margin-right: 10px;">${dict.description}</span>
                <span class="dictionary-arrow"><i class="fas fa-external-link-alt"></i></span>
            </div>
        </a>
    `).join('');
    
    document.getElementById('dictionary-links').innerHTML = linksHTML;
    
    document.getElementById('quick-reference-speak-btn').onclick = () => {
        playCurrentWord();
    };
    
    document.getElementById('quick-reference-modal').classList.add('active');
}

function playCurrentWord() {
    if (!appState.currentWord) return;
    
    const language = appState.currentLesson?.language || 'Inglés';
    voiceSystem.speakText(appState.currentWord, language);
    soundSystem.play('click');
}

function readAloudSection(text, language) {
    if (!appState.ttsEnabled) {
        alert('El sistema TTS está desactivado. Actívalo para escuchar.');
        return;
    }
    
    soundSystem.play('click');
    voiceSystem.speakText(text, language);
}

function readAloudVocabularyTable() {
    if (!appState.ttsEnabled) {
        alert('El sistema TTS está desactivado. Actívalo para escuchar.');
        return;
    }
    
    soundSystem.play('click');
    
    const words = Object.values(appState.quickReferenceData).map(item => item.word);
    if (words.length > 0) {
        const text = words.join(', ');
        const language = appState.currentLesson?.language || 'Inglés';
        voiceSystem.speakText(text, language);
    }
}

function toggleTTS() {
    appState.ttsEnabled = !appState.ttsEnabled;
    
    const toggleBtn = document.getElementById('tts-toggle-btn');
    if (toggleBtn) {
        if (appState.ttsEnabled) {
            toggleBtn.classList.add('active');
            toggleBtn.classList.remove('disabled');
            toggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            toggleBtn.title = 'TTS activado. Haz clic para desactivar.';
        } else {
            toggleBtn.classList.remove('active');
            toggleBtn.classList.add('disabled');
            toggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            toggleBtn.title = 'TTS desactivado. Haz clic para activar.';
        }
    }
    
    soundSystem.play('click');
    applyClickableTTS();
    
    localStorage.setItem('openLingo_ttsEnabled', JSON.stringify(appState.ttsEnabled));
}

// ==================== INICIALIZACIÓN ====================
document.addEventListener('DOMContentLoaded', function() {
    const savedTTS = localStorage.getItem('openLingo_ttsEnabled');
    appState.ttsEnabled = savedTTS !== null ? JSON.parse(savedTTS) : true;
    
    utils.loadFavorites();
    utils.loadLessons();
    
    soundSystem = new SoundSystem();
    voiceSystem = new VoiceSystem();
    
    appState.availableTopics = new Set(utils.extractUniqueTopics(appState.allLessons));
    
    applyFilters();
    updateCounters();
    updateFilterOptions();
    
    document.getElementById('sound-toggle').addEventListener('click', function() {
        soundSystem.toggle();
        this.classList.add('pulse');
        setTimeout(() => this.classList.remove('pulse'), 300);
    });
    
    document.getElementById('tts-toggle').addEventListener('click', function() {
        const panel = document.getElementById('tts-panel');
        panel.classList.toggle('active');
        soundSystem.play('click');
        this.classList.add('pulse');
        setTimeout(() => this.classList.remove('pulse'), 300);
    });
    
    document.getElementById('tts-speed-slider')?.addEventListener('input', function() {
        const value = parseFloat(this.value);
        document.getElementById('tts-speed-value').textContent = value.toFixed(1);
        voiceSystem.rate = value;
        voiceSystem.saveSettings();
    });
    
    document.getElementById('tts-voice-select')?.addEventListener('change', function() {
        voiceSystem.currentVoice = this.value;
        voiceSystem.saveSettings();
        soundSystem.play('click');
    });
    
    document.getElementById('test-tts-btn')?.addEventListener('click', function() {
        soundSystem.play('click');
        voiceSystem.speakText("Hello! This is a test of the text-to-speech system.", 'inglés');
    });
    
    document.getElementById('refresh-lessons-btn').addEventListener('click', function() {
        soundSystem.play('click');
        this.classList.add('pulse');
        setTimeout(() => this.classList.remove('pulse'), 300);
        
        utils.loadLessons();
        appState.availableTopics = new Set(utils.extractUniqueTopics(appState.allLessons));
        updateFilterOptions();
        applyFilters();
        updateCounters();
        
        alert('Lecciones actualizadas correctamente');
    });
    
    document.getElementById('show-import-btn').addEventListener('click', function() {
        soundSystem.play('click');
        document.getElementById('import-section').classList.toggle('hidden');
    });
    
    document.getElementById('generate-prompt-btn').addEventListener('click', function() {
        soundSystem.play('click');
        document.getElementById('ai-prompt-modal').classList.add('active');
        
        document.getElementById('language').addEventListener('change', handleLanguageChange);
        
        const updatePrompt = () => {
            const topic = document.getElementById('topic').value || 'General';
            const tags = document.getElementById('tags').value || '';
            const languageSelect = document.getElementById('language');
            const selectedLanguage = languageSelect.value;
            const otherLanguage = document.getElementById('other-language').value;
            const language = selectedLanguage === 'Otro' && otherLanguage ? otherLanguage : selectedLanguage;
            const level = document.getElementById('level').value;
            const duration = parseInt(document.getElementById('duration').value);
            const additionalComments = document.getElementById('additional-comments').value || '';
            
            const exercisesCount = Math.round(duration / 2);
            
            const prompt = `Como experto en enseñanza de idiomas, genera una lección en formato JSON EXACTO.

TEMA: "${topic}"
ETIQUETAS: "${tags}"
IDIOMA: ${language}
NIVEL: ${level}
DURACIÓN: ${duration} minutos (aproximadamente ${exercisesCount} ejercicios)
${additionalComments ? `COMENTARIOS ADICIONALES: ${additionalComments}` : ''}

FORMATO REQUERIDO:
{
    "lessonTitle": "Título de la lección sobre ${topic} en ${language}",
    "level": "${level}",
    "topic": "${topic}",
    "tags": [${tags.split(',').map(tag => `"${tag.trim()}"`).join(', ')}],
    "duration": ${duration},
    "introduction": "Introducción sobre el tema...",
    "vocabulary": [
        {
            "englishWord": "word",
            "spanishTranslation": "traducción",
            "pronunciation": "pronunciación",
            "example": "ejemplo de uso",
            "partOfSpeech": "categoría gramatical",
            "synonyms": ["sinónimo1", "sinónimo2"],
            "category": "${topic}"
        }
    ],
    "exercises": [
        {
            "type": "multiple_choice",
            "question": "Pregunta en ${language}",
            "options": ["Opción 1", "Opción 2", "Opción 3", "Opción 4"],
            "correctOption": "Texto EXACTO de la opción correcta",
            "completeAnswer": "Pregunta opción correcta sin signos de puntuación"
        }
    ]
}

REGLAS:
1. SOLO devuelve el JSON.
2. "completeAnswer" solo letras y espacios.
3. Preguntas en ${language}.
4. Traducciones en español.
5. Ejercicios apropiados para nivel ${level}.
6. Incluye partOfSpeech y synonyms en vocabulario.
7. Genera aproximadamente ${exercisesCount} ejercicios (${duration} minutos).
${additionalComments ? `8. Considera estos comentarios adicionales: "${additionalComments}"` : ''}
${additionalComments ? `9. Si se mencionan temas específicos en los comentarios, inclúyelos en la lección.` : ''}`;
            
            document.getElementById('generated-prompt').textContent = prompt;
        };
        
        document.getElementById('ai-prompt-form').addEventListener('input', updatePrompt);
        updatePrompt();
        
        document.getElementById('copy-prompt-btn').addEventListener('click', async function() {
            const promptText = document.getElementById('generated-prompt').textContent;
            if (await utils.copyToClipboard(promptText)) {
                soundSystem.play('success');
                this.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                setTimeout(() => {
                    this.innerHTML = '<i class="far fa-copy"></i> Copiar';
                }, 2000);
            }
        });
    });
    
    document.getElementById('import-lesson-btn').addEventListener('click', function() {
        const jsonStr = document.getElementById('lesson-json-input').value.trim();
        
        if (!jsonStr) {
            soundSystem.play('error');
            alert('Pega el JSON de la lección primero');
            return;
        }
        
        if (!utils.isValidJson(jsonStr)) {
            soundSystem.play('error');
            alert('JSON inválido');
            return;
        }
        
        try {
            const promptData = JSON.parse(jsonStr);
            let lessonToImport;
            
            if (promptData.lessonTitle || (promptData.vocabulary && promptData.exercises)) {
                if (promptData.exercises) {
                    promptData.exercises.forEach(exercise => {
                        if (exercise.type === 'multiple_choice' || exercise.exerciseType === 'multiple_choice') {
                            exercise.questionToSpeak = exercise.question || '';
                            let correctOptionText = '';
                            if (exercise.options && exercise.correctOption) {
                                if (typeof exercise.correctOption === 'string') {
                                    correctOptionText = exercise.correctOption;
                                } else {
                                    const correctIndex = parseInt(exercise.correctOption);
                                    correctOptionText = exercise.options[correctIndex] || '';
                                }
                            }
                            exercise.correctOptionText = correctOptionText;
                        } else if (exercise.type === 'true_false' || exercise.exerciseType === 'true_false') {
                            exercise.questionToSpeak = exercise.statement || '';
                            const correctOptionText = exercise.correctAnswer ? 'Verdadero' : 'Falso';
                            exercise.correctOptionText = correctOptionText;
                        }
                    });
                }
                lessonToImport = utils.convertPromptFormatToInternalFormat(promptData);
            } else if (promptData.title && promptData.language && promptData.sections) {
                lessonToImport = promptData;
            } else {
                throw new Error('Formato no reconocido');
            }
            
            const exerciseSection = lessonToImport.sections?.find(s => s.type === 'exercises');
            if (exerciseSection?.items) {
                exerciseSection.items.forEach(item => {
                    if (item.completeAnswer) {
                        item.completeAnswer = utils.cleanCorrectAnswer(item.completeAnswer);
                    }
                    if (!item.questionToSpeak) {
                        item.questionToSpeak = item.question || item.statement || '';
                    }
                    if (!item.correctOptionText) {
                        if (item.type === 'multiple_choice') {
                            item.correctOptionText = item.options ? item.options[item.correctAnswer] || '' : '';
                        } else if (item.type === 'true_false') {
                            item.correctOptionText = item.correctAnswer ? 'Verdadero' : 'Falso';
                        }
                    }
                });
            }
            
            utils.addLesson(lessonToImport);
            
            appState.availableTopics.add(lessonToImport.topic);
            updateFilterOptions();
            applyFilters();
            updateCounters();
            
            document.getElementById('lesson-json-input').value = '';
            document.getElementById('import-section').classList.add('hidden');
            soundSystem.play('success');
            alert('Lección importada correctamente');
            
        } catch (error) {
            console.error('Error:', error);
            soundSystem.play('error');
            alert('Error: ' + error.message);
        }
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            switchTab(tabId);
        });
    });
    
    document.getElementById('search-btn').addEventListener('click', function() {
        soundSystem.play('click');
        const searchTerm = document.getElementById('search-input').value.trim();
        appState.activeFilters.search = searchTerm;
        applyFilters();
        updateActiveFiltersDisplay();
    });
    
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            soundSystem.play('click');
            const searchTerm = this.value.trim();
            appState.activeFilters.search = searchTerm;
            applyFilters();
            updateActiveFiltersDisplay();
        }
    });
    
    document.getElementById('favorites-search-btn').addEventListener('click', function() {
        soundSystem.play('click');
        const searchTerm = document.getElementById('favorites-search-input').value.trim();
        appState.favoriteFilters.search = searchTerm;
        applyFilters();
    });
    
    document.getElementById('favorites-search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            soundSystem.play('click');
            const searchTerm = this.value.trim();
            appState.favoriteFilters.search = searchTerm;
            applyFilters();
        }
    });
    
    document.getElementById('language-filter').addEventListener('change', function() {
        soundSystem.play('click');
        appState.activeFilters.language = this.value;
        applyFilters();
        updateActiveFiltersDisplay();
    });
    
    document.getElementById('level-filter').addEventListener('change', function() {
        soundSystem.play('click');
        appState.activeFilters.level = this.value;
        applyFilters();
        updateActiveFiltersDisplay();
    });
    
    document.getElementById('topic-filter').addEventListener('change', function() {
        soundSystem.play('click');
        appState.activeFilters.topic = this.value;
        applyFilters();
        updateActiveFiltersDisplay();
    });
    
    document.getElementById('favorites-language-filter').addEventListener('change', function() {
        soundSystem.play('click');
        appState.favoriteFilters.language = this.value;
        applyFilters();
    });
    
    document.getElementById('favorites-level-filter').addEventListener('change', function() {
        soundSystem.play('click');
        appState.favoriteFilters.level = this.value;
        applyFilters();
    });
    
    document.querySelectorAll('.close-modal, .close-lesson-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            soundSystem.play('click');
            const modalId = this.closest('.modal').id;
            if (modalId === 'ai-prompt-modal') {
                document.getElementById('ai-prompt-modal').classList.remove('active');
            } else if (modalId === 'lesson-modal') {
                document.getElementById('lesson-modal').classList.remove('active');
            }
            voiceSystem.stopListening();
        });
    });
    
    document.querySelectorAll('.close-quick-reference').forEach(btn => {
        btn.addEventListener('click', function() {
            soundSystem.play('click');
            document.getElementById('quick-reference-modal').classList.remove('active');
        });
    });
    
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                soundSystem.play('click');
                this.classList.remove('active');
                voiceSystem.stopListening();
            }
        });
    });
    
    document.getElementById('quick-reference-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            soundSystem.play('click');
            this.classList.remove('active');
        }
    });
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn') && !e.target.closest('#sound-toggle') && !e.target.closest('#tts-toggle')) {
            soundSystem.play('click');
        }
    });
});
</script>
</body>
</html>
